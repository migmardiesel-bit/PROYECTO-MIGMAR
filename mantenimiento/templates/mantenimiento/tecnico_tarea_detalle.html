{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid py-3 px-3">
    <div class="row g-3">
        <!-- Contenido principal - Ahora aparece primero en móviles -->
        <div class="col-12">
            <div class="mb-3">
                <h2 class="h4 mb-1">{{ titulo }}</h2>
                <p class="text-muted small">ID: {{ tarea.id }} | {{ tarea.get_tipo_mantenimiento_display }}</p>
            </div>

            {% if tarea.status == 'ASIGNADA' %}
                <!-- Paso 1: Preparar Herramientas -->
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-warning-light border-0 py-2">
                        <h5 class="mb-0 fs-6">
                            <i class="fas fa-tools me-2"></i>Paso 1: Preparar Herramientas
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <form method="POST" action="{% url 'mantenimiento:seleccionar_herramientas' tarea.pk %}">
                            {% csrf_token %}
                            <p class="small">Selecciona el equipo y herramientas que necesitarás para completar esta tarea.</p>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold small">Herramientas Requeridas</label>
                                {{ form_herramientas.herramientas }}
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                                <i class="fas fa-save me-2"></i>Guardar Herramientas
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Paso 2: Iniciar Tarea -->
                {% if tarea.herramientas_solicitadas.exists %}
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success-light border-0 py-2">
                        <h5 class="mb-0 fs-6">
                            <i class="fas fa-play-circle me-2"></i>Paso 2: Iniciar Tarea
                        </h5>
                    </div>
                    <div class="card-body p-3">
                        <p class="fw-bold text-success small">¡Herramientas guardadas con éxito!</p>
                        <p class="small">Has seleccionado {{ tarea.herramientas_solicitadas.count }} herramienta(s). Presiona el botón para iniciar el trabajo y comenzar a contar el tiempo.</p>
                        
                        <h6 class="mb-2 small">Herramientas a Usar:</h6>
                        <div class="d-flex flex-wrap gap-1 mb-3">
                            {% for herram in tarea.herramientas_solicitadas.all %}
                            <span class="badge bg-light text-dark border small">
                                <i class="fas fa-tool-box me-1"></i>{{ herram.nombre }}
                            </span>
                            {% endfor %}
                        </div>

                        <form method="POST" action="{% url 'mantenimiento:iniciar_tarea' tarea.pk %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success w-100 py-3 fw-bold">
                                <i class="fas fa-stopwatch me-2"></i>Iniciar Tarea
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
            
            {% elif tarea.status == 'EN_PROCESO' %}
            <!-- Tarea en Progreso -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-info-light border-0 py-2">
                    <h5 class="mb-0 fs-6">
                        <i class="fas fa-cogs me-2"></i>Tarea en Progreso
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div class="alert alert-info d-flex align-items-center p-2">
                        <i class="fas fa-clock me-3"></i>
                        <div class="small">
                            <strong>Tarea iniciada:</strong> {{ tarea.fecha_inicio|date:"d/m/Y H:i" }} ({{ tarea.fecha_inicio|naturaltime }})
                            <br>
                            <strong>Tiempo transcurrido:</strong> 
                            <span id="tiempo-transcurrido" class="fw-bold">0 min</span>
                        </div>
                    </div>

                    {% if tarea.tipo_mantenimiento == 'PREVENTIVO' %}
                    <h5 class="mt-3 mb-2 fs-6">
                        <i class="fas fa-list-check me-2"></i>Checklist de Tareas
                    </h5>
                    <form method="POST" action="{% url 'mantenimiento:guardar_progreso_preventivo' tarea.pk %}" class="mb-3">
                        {% csrf_token %}
                        {{ formset_preventivo.management_form }}
                        
                        <ul class="list-group list-group-flush">
                            {% for form in formset_preventivo %}
                            <li class="list-group-item px-1 py-2">
                                <div class="form-check form-switch d-flex align-items-center">
                                    {{ form.id }}
                                    <input class="form-check-input me-3" type="checkbox" role="switch"
                                           id="{{ form.completada.id_for_label }}" 
                                           name="{{ form.completada.html_name }}"
                                           {% if form.completada.value %}checked{% endif %}>
                                    <label class="form-check-label fw-medium small" for="{{ form.completada.id_for_label }}">
                                        {{ form.completada.label }}
                                    </label>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        
                        <button type="submit" class="btn btn-outline-primary w-100 mt-3 py-2">
                            <i class="fas fa-save me-2"></i>Guardar Progreso
                        </button>
                    </form>
                    
                    {% elif tarea.tipo_mantenimiento == 'CORRECTIVO' %}
                    <h5 class="mt-3 mb-2 fs-6">
                        <i class="fas fa-tools me-2"></i>Tarea Correctiva Asignada
                    </h5>
                    <div class="card bg-light border-0">
                        <div class="card-body p-2">
                            <h6 class="card-title small">{{ tarea.mantenimiento_correctivo.nombre }}</h6>
                            <p class="card-text small">{{ tarea.mantenimiento_correctivo.descripcion|default:"Sin descripción detallada." }}</p>
                        </div>
                    </div>
                    <p class="small text-muted mt-3">Una vez completada la reparación, presiona "Finalizar Tarea".</p>
                    {% endif %}

                    <hr class="my-3">
                    <h5 class="text-danger fs-6">Finalizar Tarea</h5>
                    <p class="small">Una vez que hayas completado todo el trabajo, presiona este botón. Se detendrá el tiempo y se marcará la tarea como completada.</p>
                    <form method="POST" action="{% url 'mantenimiento:finalizar_tarea' tarea.pk %}" class="mt-3">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger w-100 py-3 fw-bold" 
                                onclick="return confirm('¿Estás seguro de que deseas finalizar esta tarea? Se calculará el tiempo total empleado.');">
                            <i class="fas fa-stop-circle me-2"></i>Finalizar y Enviar Reporte
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Panel de detalles - Ahora aparece después en móviles -->
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light border-0 py-2">
                    <h5 class="mb-0 fs-6">
                        <i class="fas fa-info-circle text-primary me-2"></i>Detalles de la Tarea
                    </h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted d-block">Unidad</small>
                                <span class="fw-bold">{{ tarea.unidad.nombre }}</span>
                            </div>
                            <i class="fas fa-truck text-muted"></i>
                        </li>
                        <li class="list-group-item">
                            <small class="text-muted d-block">Estado</small>
                            <span class="badge
                                {% if tarea.status == 'ASIGNADA' %} bg-warning text-dark
                                {% elif tarea.status == 'EN_PROCESO' %} bg-info text-dark
                                {% else %} bg-success {% endif %}">
                                {{ tarea.get_status_display }}
                            </span>
                        </li>
                        <li class="list-group-item">
                            <small class="text-muted d-block">Prioridad</small>
                            <span class="badge
                                {% if tarea.prioridad == 'ALTA' %} bg-danger
                                {% elif tarea.prioridad == 'MEDIA' %} bg-warning text-dark
                                {% else %} bg-success {% endif %}">
                                {{ tarea.get_prioridad_display }}
                            </span>
                        </li>
                        <li class="list-group-item">
                            <small class="text-muted d-block">Tipo</small>
                            <span class="fw-medium">{{ tarea.get_tipo_mantenimiento_display }}</span>
                        </li>
                        <li class="list-group-item">
                            <small class="text-muted d-block">Asignada por</small>
                            <span class="fw-medium">{{ tarea.admin.get_full_name|default:tarea.admin.username }}</span>
                        </li>
                        <li class="list-group-item">
                            <small class="text-muted d-block">Fecha Asignación</small>
                            <span class="fw-medium">{{ tarea.fecha_asignacion|date:"d/m/Y H:i" }}</span>
                        </li>
                    </ul>
                </div>
                {% if tarea.notas_admin %}
                <div class="card-footer bg-light border-0 p-2">
                    <small class="text-muted d-block mb-1">
                        <i class="fas fa-clipboard me-1"></i>Notas del Administrador
                    </small>
                    <div class="alert alert-secondary small p-2 mb-0">
                        {{ tarea.notas_admin }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#{{ form_herramientas.herramientas.id_for_label }}').select2({
        theme: "bootstrap-5",
        placeholder: "Escribe para buscar herramientas...",
        closeOnSelect: false,
        width: '100%',
        dropdownParent: $('#{{ form_herramientas.herramientas.id_for_label }}').parent()
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if tarea.status == 'EN_PROCESO' and tarea.fecha_inicio %}
    const fechaInicio = new Date("{{ tarea.fecha_inicio.isoformat }}");
    const elementoTiempo = document.getElementById('tiempo-transcurrido');

    function actualizarTiempoTranscurrido() {
        const ahora = new Date();
        const diferenciaMs = ahora - fechaInicio;
        const minutosTranscurridos = Math.floor(diferenciaMs / (1000 * 60));
        
        if (elementoTiempo) {
            if (minutosTranscurridos < 60) {
                elementoTiempo.textContent = minutosTranscurridos + ' min';
            } else {
                const horas = Math.floor(minutosTranscurridos / 60);
                const minutos = minutosTranscurridos % 60;
                elementoTiempo.textContent = `${horas}h ${minutos}min`;
            }
        }
    }
    
    // Actualizar inmediatamente y luego cada 30 segundos
    actualizarTiempoTranscurrido();
    setInterval(actualizarTiempoTranscurrido, 30000);
    {% endif %}
});
</script>

<style>
    /* Colores claros para fondos de cabecera */
    :root {
        --bs-warning-light: #fff8e6;
        --bs-success-light: #e6f7f0;
        --bs-info-light: #e3f8fb;
    }
    .bg-warning-light { background-color: var(--bs-warning-light) !important; }
    .bg-success-light { background-color: var(--bs-success-light) !important; }
    .bg-info-light { background-color: var(--bs-info-light) !important; }

    /* Ajustes para Select2 en móviles */
    .select2-container--bootstrap-5 .select2-selection {
        border-radius: 0.375rem !important;
        min-height: 42px !important;
        padding-top: 5px;
    }
    .select2-container--bootstrap-5 .select2-dropdown {
        border-radius: 0.375rem !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    /* Mejoras para móviles */
    .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
    }
    
    .card-body {
        padding: 12px !important;
    }
    
    .card-header {
        padding: 8px 12px !important;
    }
    
    .btn {
        padding: 10px 15px !important;
    }
    
    .badge {
        font-size: 0.75rem !important;
    }
    
    .list-group-item {
        padding: 8px 12px !important;
    }
    
    /* Ajustes del switch para móviles */
    .form-switch .form-check-input {
        width: 2.5rem;
        height: 1.25rem;
    }
    
    /* Limpieza del checklist */
    .list-group-item {
        border-color: rgba(0,0,0,0.05);
    }
    
    /* Mejoras de legibilidad */
    h2, h5, h6 {
        word-wrap: break-word;
    }
    
    /* Ajustes de iconos */
    .fas {
        font-size: 0.9em;
    }
</style>
{% endblock %}