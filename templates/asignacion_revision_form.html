{% extends 'base.html' %}
{% load humanize %}

{% block content %}

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-bell me-2"></i>
            <strong class="me-auto" id="toast-title">Notificación</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body">
            Mensaje de notificación.
        </div>
    </div>
</div>
<div class="container-fluid py-4">

    <div class="row mb-4 g-4">
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-calendar-day fs-5"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">Total Asignaciones (Hoy)</h6>
                        <h3 class="fw-bold mb-0">{{ stats.total|default:0 }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 bg-success bg-opacity-10 text-success rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-clock fs-5"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">Pendientes</h6>
                        <h3 class="fw-bold mb-0">{{ stats.pendientes|default:0 }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 bg-info bg-opacity-10 text-info rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-cogs fs-5"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">En Proceso</h6>
                        <h3 class="fw-bold mb-0">{{ stats.en_proceso|default:0 }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 bg-dark bg-opacity-10 text-dark rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-check-circle fs-5"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">Terminadas (Hoy)</h6>
                        <h3 class="fw-bold mb-0">{{ stats.terminadas|default:0 }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-4">
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow-lg border-0 h-100">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 bg-white bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="fas fa-plus text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-0 fw-bold">{{ titulo }}</h5>
                            <small class="opacity-75">Asignar nueva revisión de unidad</small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="{{ form.unidad.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-bus me-2 text-primary"></i>Unidad
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-list text-primary"></i>
                                </span>
                                {{ form.unidad }}
                            </div>
                            <div class="form-text">Seleccione la unidad a revisar</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.fecha_revision.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-calendar-alt me-2 text-primary"></i>Fecha de Revisión
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-clock text-primary"></i>
                                </span>
                                {{ form.fecha_revision }}
                            </div>
                            <div class="form-text">Programe la fecha de revisión</div>
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100 py-3 rounded-pill fw-bold mt-3 shadow-sm">
                            <i class="fas fa-plus-circle me-2"></i> Asignar Unidad
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-8 col-lg-7">
            <div class="card shadow-lg border-0 h-100">
                 <div class="card-header bg-gradient-info text-white py-3">
                     <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div class="d-flex align-items-center mb-2 mb-md-0">
                            <div class="flex-shrink-0 bg-white bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="fas fa-clipboard-list text-primary"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="mb-0 fw-bold">Asignaciones del Día</h5>
                                <small class="opacity-75">Revisiones programadas para la fecha seleccionada</small>
                            </div>
                        </div>
                        
                        <!-- Reemplazado: formulario de filtro + botón "Ver Monitor" -->
                        <div class="d-flex align-items-center">
                            <form method="get" class="d-flex align-items-center me-2">
                                <div class="input-group input-group-sm shadow-sm">
                                    <span class="input-group-text bg-white border-end-0">
                                        <i class="fas fa-filter text-primary"></i>
                                    </span>
                                    <input id="filterFechaInput" type="date" name="fecha" value="{{ fecha_filtro|date:'Y-m-d' }}" class="form-control border-start-0">
                                    <button type="submit" class="btn btn-light border">
                                        <i class="fas fa-search me-1 text-primary"></i> Filtrar
                                    </button>
                                </div>
                            </form>

                            <!-- Botón Ver Monitor: data-base-url contiene la ruta base y se actualizará desde JS -->
                            <a id="verMonitorBtn" data-base-url="{% url 'monitor-revisiones' %}" 
                               href="{% url 'monitor-revisiones' %}?fecha={{ fecha_filtro|date:'Y-m-d' }}" 
                               class="btn btn-light btn-sm shadow-sm text-primary fw-bold">
                                <i class="fas fa-tv me-1"></i> Ver Monitor
                            </a>
                        </div>
                    </div>
                    
                    <div class="card-body p-3 bg-light-subtle border-top border-bottom">
                        <div class="row g-2">
                            <div class="col-md-7">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white"><i class="fas fa-search text-primary"></i></span>
                                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por unidad u operador...">
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white"><i class="fas fa-check-circle text-primary"></i></span>
                                    <select id="statusFilter" class="form-select">
                                        <option value="ALL" selected>Todos los Estatus</option>
                                        <option value="PENDIENTE">Pendiente</option>
                                        <option value="EN_PROCESO">En Proceso</option>
                                        <option value="TERMINADO">Terminado</option>
                                        <option value="CANCELADO">Cancelado</option>
                                        <option value="NO_VINO">No Vino</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                             <thead class="table-dark">
                                <tr>
                                    <th class="ps-4">Unidad / Operador</th>
                                    <th>Estatus</th>
                                    <th>Asignado Por</th>
                                    <th>Última Rev.</th>
                                    <th class="text-center pe-4">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="assignmentsTableBody">
                                {% for asignacion in asignaciones_del_dia %}
                                <tr class="asignacion-row {% if asignacion.status != 'PENDIENTE' %}table-active{% endif %} 
                                           {% if asignacion.bad_items_list %}table-warning-custom{% endif %}"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#checklistModal-{{ asignacion.pk }}" 
                                    style="cursor: pointer;"
                                    title="Clic para ver detalles del último checklist"
                                    data-status="{{ asignacion.status }}"
                                    data-searchable-text="{{ asignacion.unidad.nombre }} {{ asignacion.unidad.operador_actual.nombre_completo|default:'' }}">

                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                                <i class="fas fa-bus text-primary"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <strong class="fw-semibold d-block">{{ asignacion.unidad.nombre }}</strong>
                                                <small class="text-muted"><i class="fas fa-user me-1"></i> {{ asignacion.unidad.operador_actual.nombre_completo|default:"Sin operador" }}</small>
                                                {% if asignacion.bad_items_list %}
                                                    <span class="badge bg-danger rounded-pill ms-1" title="Esta unidad tiene fallas reportadas en su último checklist">
                                                        <i class="fas fa-exclamation-triangle me-1"></i> {{ asignacion.bad_items_list|length }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    
                                    <td>
                                        {% if asignacion.status == 'PENDIENTE' %}
                                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3 py-2">
                                                <i class="fas fa-clock me-1"></i> Pendiente
                                            </span>
                                        {% elif asignacion.status == 'EN_PROCESO' %}
                                            <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 rounded-pill px-3 py-2">
                                                <i class="fas fa-cogs fa-spin me-1"></i> En Proceso
                                            </span>
                                        {% elif asignacion.status == 'TERMINADO' %}
                                            <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 rounded-pill px-3 py-2">
                                                <i class="fas fa-check-circle me-1"></i> Terminado
                                            </span>
                                        {% elif asignacion.status == 'CANCELADO' %}
                                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill px-3 py-2">
                                                <i class="fas fa-ban me-1"></i> Cancelado
                                            </span>
                                        {% elif asignacion.status == 'NO_VINO' %}
                                            <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 rounded-pill px-3 py-2">
                                                <i class="fas fa-user-times me-1"></i> No Vino
                                            </span>
                                        {% endif %}
                                        
                                        {% if asignacion.comentario_cancelacion %}
                                            <div class="mt-2 p-2 bg-light rounded">
                                                <p class="small text-muted mb-0 fst-italic">
                                                    <i class="fas fa-comment me-1 text-primary"></i> "{{ asignacion.comentario_cancelacion }}"
                                                </p>
                                            </div>
                                        {% endif %}
                                    </td>
                                    
                                    <td>
                                        <small class="text-muted">{{ asignacion.creado_por.username|default:"N/A" }}</small>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ asignacion.unidad.ultima_revision_fecha|date:"d M, Y"|default:"-" }}</small>
                                    </td>
                                    <td class="text-center pe-4">
                                         {% if asignacion.status == 'PENDIENTE' %}
                                        <button type="button" class="btn btn-outline-danger btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#cancelModal-{{ asignacion.pk }}" 
                                                onclick="event.stopPropagation();">
                                            <i class="fas fa-ban me-1"></i> Cancelar
                                        </button>
                                        {% else %}
                                            <span class="text-muted small">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                
                                <div class="modal fade" id="cancelModal-{{ asignacion.pk }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content border-0 shadow-lg">
                                            <div class="modal-header bg-danger text-white">
                                                <h5 class="modal-title">
                                                    <i class="fas fa-exclamation-triangle me-2"></i> Cancelar Revisión
                                                </h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form action="{% url 'cancelar-revision' asignacion.pk %}" method="post">
                                                {% csrf_token %}
                                                <div class="modal-body py-4">
                                                    <div class="alert alert-warning d-flex align-items-center" role="alert">
                                                        <i class="fas fa-info-circle me-2 fs-5 text-primary"></i>
                                                        <div>
                                                            Está a punto de cancelar la revisión de <strong>{{ asignacion.unidad.nombre }}</strong>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label fw-semibold">Motivo de Cancelación</label>
                                                        <select name="status" class="form-select" required>
                                                            <option value="CANCELADO">Cancelado (Taller)</option>
                                                            <option value="NO_VINO">No se presentó la unidad</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label fw-semibold">Comentario Adicional</label>
                                                        <textarea name="comentario" class="form-control" rows="3" placeholder="Agregue detalles sobre la cancelación..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                                                    <button type="submit" class="btn btn-danger rounded-pill px-4">
                                                        <i class="fas fa-ban me-1"></i> Confirmar Cancelación
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- === MODAL CHECKLIST (REEMPLAZADO) === -->
                                <div class="modal fade" id="checklistModal-{{ asignacion.pk }}" tabindex="-1" aria-hidden="true" 
                                     data-unidad-pk="{{ asignacion.unidad.pk }}"> <div class="modal-dialog modal-dialog-centered modal-xl">
                                        <div class="modal-content border-0 shadow-lg">
                                            <div class="modal-header bg-warning text-dark">
                                                <h5 class="modal-title">
                                                    <i class="fas fa-tools me-2"></i> Fallas Reportadas: {{ asignacion.unidad.nombre }}
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body p-4 bg-light">
                                                
                                                <div class="report-controls border rounded p-3 mb-4 bg-white shadow-sm" onclick="event.stopPropagation();">
                                                    <h6 class="mb-3 fw-bold"><i class="fas fa-history me-2 text-primary"></i>Historial de Correcciones de la Unidad</h6>
                                                    <form class="report-filter-form row g-2 align-items-end mb-3">
                                                        <div class="col-md-4">
                                                            <label for="report_start_date-{{ asignacion.pk }}" class="form-label form-label-sm fw-bold">Desde:</label>
                                                            <input type="date" id="report_start_date-{{ asignacion.pk }}" class="form-control form-control-sm report-date-filter" 
                                                                   value="{% now 'Y-m-01' %}"> </div>
                                                        <div class="col-md-4">
                                                            <label for="report_end_date-{{ asignacion.pk }}" class="form-label form-label-sm fw-bold">Hasta:</label>
                                                            <input type="date" id="report_end_date-{{ asignacion.pk }}" class="form-control form-control-sm report-date-filter"
                                                                   value="{% now 'Y-m-d' %}"> </div>
                                                        <div class="col-md-4 d-flex justify-content-end">
                                                            <a href="#" class="btn btn-danger btn-sm me-2 report-pdf-link shadow-sm" 
                                                               data-base-url="{% url 'unidad-reporte-correcciones-pdf' asignacion.unidad.pk %}"
                                                               target="_blank"> <i class="fas fa-file-pdf me-1"></i> PDF
                                                            </a>
                                                            <a href="#" class="btn btn-success btn-sm report-excel-link shadow-sm"
                                                               data-base-url="{% url 'unidad-reporte-correcciones-excel' asignacion.unidad.pk %}"
                                                               target="_blank"> <i class="fas fa-file-excel me-1"></i> Excel
                                                            </a>
                                                        </div>
                                                    </form>
                                                </div>

                                                {% if asignacion.bad_items_list %}
                                                    <div class="alert alert-light" role="alert">
                                                        Mostrando <strong>{{ asignacion.bad_items_list|length }}</strong> falla(s) del último checklist (Fecha: {{ asignacion.latest_checklist_date|date:"d M, Y H:i" }})
                                                    </div>

                                                    <div class="list-group list-group-flush shadow-sm">
                                                        {% for item in asignacion.bad_items_list %}
                                                        <div class="list-group-item p-3" onclick="event.stopPropagation();">
                                                            <div class="row g-3 align-items-start">
                                                                <div class="col-auto">
                                                                    {% if item.foto and item.foto.url %}
                                                                        <img src="{{ item.foto.url }}" 
                                                                             class="img-thumbnail img-clickable" 
                                                                             alt="Evidencia de {{ item.label }}"
                                                                             data-bs-toggle="modal" 
                                                                             data-bs-target="#image-viewer-modal"
                                                                             data-full-src="{{ item.foto.url }}"
                                                                             onclick="event.stopPropagation();">
                                                                    {% else %}
                                                                        <div class="img-thumbnail-placeholder">
                                                                            <i class="fas fa-camera-slash fa-2x text-muted"></i>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>

                                                                <div class="col-md-4">
                                                                    <strong class="d-block text-dark">{{ item.label }}</strong>
                                                                    <small class="text-muted fst-italic">"{{ item.obs|default:"Sin observación."|truncatechars:100 }}"</small>
                                                                </div>

                                                                <div class="col-md-5">
                                                                    <div class="form-floating">
                                                                        <textarea class="form-control" placeholder="Comentario de Admin" 
                                                                                  id="comentario-{{ item.id }}" 
                                                                                  style="height: 100px"
                                                                                  {% if item.status_raw != 'PENDIENTE' %}readonly{% endif %}>{{ item.comentario_admin|default:"" }}</textarea>
                                                                        <label for="comentario-{{ item.id }}">Comentario de Corrección (Admin)</label>
                                                                    </div>

                                                                    {% comment %} Mostrar estado si no está pendiente y hay fecha de acción {% endcomment %}
                                                                    {% if item.status_raw != 'PENDIENTE' and item.fecha_correccion %}
                                                                        <div class="alert 
                                                                            {% if item.status_raw == 'CORREGIDO' %}alert-success{% else %}alert-secondary{% endif %} 
                                                                            d-flex align-items-center mt-2 p-2" role="alert">
                                                                            <i class="fas {% if item.status_raw == 'CORREGIDO' %}fa-check-circle{% else %}fa-ban{% endif %} me-2"></i>
                                                                            <small>
                                                                                {{ item.status }} por <strong>{{ item.corregido_por.username|default:'N/A' }}</strong>
                                                                                el {{ item.fecha_correccion|date:"d M Y, H:i" }}
                                                                            </small>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>

                                                                <div class="col-md-2 text-center">
                                                                    {% if item.status_raw == 'PENDIENTE' %}
                                                                        <div class="form-check form-switch mb-2">
                                                                            <input class="form-check-input check-corregir" type="checkbox" role="switch" 
                                                                                   id="corregido-{{ item.id }}" data-item-pk="{{ item.id }}">
                                                                            <label class="form-check-label" for="corregido-{{ item.id }}">
                                                                                ✅ Corregir
                                                                            </label>
                                                                        </div>

                                                                        <div class="form-check form-switch mb-2">
                                                                            <input class="form-check-input check-descartar" type="checkbox" role="switch" 
                                                                                   id="descartado-{{ item.id }}" data-item-pk="{{ item.id }}">
                                                                            <label class="form-check-label text-danger" for="descartado-{{ item.id }}">
                                                                                ❌ Descartar
                                                                            </label>
                                                                        </div>

                                                                        <button class="btn btn-success btn-sm w-100 btn-guardar-correccion shadow-sm" 
                                                                                data-item-pk="{{ item.id }}" 
                                                                                data-url="{% url 'api-corregir-falla' item.id %}">
                                                                            <i class="fas fa-save me-1"></i> Guardar
                                                                        </button>
                                                                    {% else %}
                                                                        <span class="badge 
                                                                            {% if item.status_raw == 'CORREGIDO' %}bg-success{% else %}bg-secondary{% endif %} 
                                                                            text-white rounded-pill py-2 px-3">
                                                                            {% if item.status_raw == 'CORREGIDO' %}<i class="fas fa-check-circle me-1"></i> Corregido{% else %}<i class="fas fa-ban me-1"></i> Descartado{% endif %}
                                                                        </span>

                                                                        <div class="mt-2">
                                                                            <button class="btn btn-secondary btn-sm w-100 shadow-sm" disabled>
                                                                                <i class="fas fa-lock me-1"></i> Guardado
                                                                            </button>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <div class="text-center py-4">
                                                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                                        <h5 class="text-muted">¡Sin Fallas!</h5>
                                                        <p class="text-muted">
                                                            {% if asignacion.latest_checklist_date %}
                                                                No se encontraron ítems en 'MALO' en el último checklist (Fecha: {{ asignacion.latest_checklist_date|date:"d M, Y" }}).
                                                            {% else %}
                                                                No se ha registrado ningún checklist para esta unidad.
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- === FIN MODAL CHECKLIST === -->

                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="py-4">
                                            <i class="fas fa-inbox fa-3x text-primary mb-3"></i>
                                            <h5 class="text-muted">No hay unidades asignadas para esta fecha</h5>
                                            <p class="text-muted small">Utilice el formulario para asignar una nueva revisión</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}

                                <tr id="noResultsRow" class="d-none">
                                    <td colspan="5" class="text-center py-5">
                                        <div class="py-4">
                                            <i class="fas fa-search-minus fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No se encontraron resultados</h5>
                                            <p class="text-muted small">Intente ajustar los filtros de búsqueda o estatus.</p>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="image-viewer-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Evidencia Fotográfica</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="modal-image-content" src="" class="img-fluid w-100" alt="Evidencia en tamaño completo">
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos de gradientes y tarjetas (existentes) */
    .bg-gradient-primary { background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%); }
    .bg-gradient-info { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .card { border-radius: 16px; overflow: hidden; }
    .card-header { border-bottom: 1px solid rgba(255, 255, 255, 0.2); }

    /* Estilos de tabla (existentes) */
    .table > :not(:first-child) { border-top: 2px solid #e9ecef; }
    .table-hover tbody tr:hover { background-color: rgba(58, 123, 213, 0.05); }
    .table-warning-custom { background-color: #fffbeb !important; }
    .table-hover tbody tr.table-warning-custom:hover { background-color: #fff8e1 !important; }
    
    /* Estilos de formularios (existentes) */
    .form-control, .form-select { border-radius: 8px; padding: 0.75rem 1rem; }
    .input-group-text { border-radius: 8px 0 0 8px; }
    .input-group .form-control:not(:first-child) { border-radius: 0 8px 8px 0; }
    
    /* Estilos de modal (existentes) */
    .modal-content { border-radius: 16px; }
    
    /* Estilos de botones y badges (existentes) */
    .btn { transition: all 0.2s ease-in-out; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .badge { font-weight: 500; }
    
    /* Estilos de imágenes de evidencia (existentes) */
    .img-thumbnail.img-clickable {
        width: 80px; height: 80px; object-fit: cover;
        cursor: pointer; transition: transform 0.2s;
    }
    .img-thumbnail.img-clickable:hover { transform: scale(1.1); }
    .img-thumbnail-placeholder {
        width: 80px; height: 80px;
        display: flex; align-items: center; justify-content: center;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }

    /* Estilos de reportes en modal (existentes) */
    .report-controls .form-label-sm { font-size: 0.8rem; margin-bottom: 0.25rem; }
    .report-controls .form-control-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
    .report-controls .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.875rem; }

    /* --- NUEVO ---: Estilo para spin en botones (ya lo tenías en un badge) */
    @keyframes fa-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .fa-spin {
        animation: fa-spin 1s infinite linear;
    }

    /* --- NUEVO: Estilos para el visor de imágenes en modal --- */
    #modal-image-content {
        max-height: 85vh;      /* Limita la altura para que no desborde la pantalla */
        object-fit: contain;   /* Mantiene la proporción y centra la imagen dentro del contenedor */
        width: 100%;
        display: block;
        margin: 0 auto;
        background-color: #000; /* opcional: fondo oscuro detrás de la imagen */
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // --- Función CSRF token (Existente) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- Validación Bootstrap (Existente) ---
    (function() {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
            .forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
    })();

    // --- Visor de Imágenes (Existente) ---
    const imageViewerModalEl = document.getElementById('image-viewer-modal');
    if (imageViewerModalEl) {
        imageViewerModalEl.addEventListener('show.bs.modal', function (event) {
            const trigger = event.relatedTarget; // elemento que disparó el modal (la miniatura)
            const fullSrc = trigger && trigger.dataset ? trigger.dataset.fullSrc : '';
            const modalImage = document.getElementById('modal-image-content');
            if (modalImage) {
                modalImage.src = fullSrc || '';
            }
        });

        // Limpiar src al ocultar para evitar mostrar imagen antigua al abrir sin trigger válido
        imageViewerModalEl.addEventListener('hidden.bs.modal', function () {
            const modalImage = document.getElementById('modal-image-content');
            if (modalImage) modalImage.src = '';
        });
    }


    // --- NUEVO: Lógica de Notificaciones (Toast) ---
    const toastEl = document.getElementById('liveToast');
    const toastTitleEl = document.getElementById('toast-title');
    const toastBodyEl = document.getElementById('toast-body');
    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });

    function showToast(message, type = 'success') {
        // Limpiar clases anteriores
        toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-white', 'text-dark');
        
        if (type === 'success') {
            toastTitleEl.innerText = 'Éxito';
            toastEl.classList.add('bg-success', 'text-white');
        } else if (type === 'danger') {
            toastTitleEl.innerText = 'Error';
            toastEl.classList.add('bg-danger', 'text-white');
        } else {
            toastTitleEl.innerText = 'Aviso';
            toastEl.classList.add('bg-warning', 'text-dark');
        }

        toastBodyEl.innerText = message;
        toast.show();
    }
    // --- FIN NUEVO ---


    document.addEventListener('DOMContentLoaded', () => {

        // --- Guardar Correcciones AJAX (Actualizado para corregir/descartar) ---
        const saveButtons = document.querySelectorAll('.btn-guardar-correccion');
        saveButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                const pk = this.dataset.itemPk;
                const url = this.dataset.url;

                const corregido_cb = document.getElementById(`corregido-${pk}`);
                const descartado_cb = document.getElementById(`descartado-${pk}`);
                const textarea = document.getElementById(`comentario-${pk}`);

                // Validación: No permitir ambos seleccionados
                if (corregido_cb && descartado_cb && corregido_cb.checked && descartado_cb.checked) {
                    showToast('No puede marcar un ítem como "Corregido" y "Descartado" al mismo tiempo.', 'danger');
                    return;
                }

                const data = {
                    marcar_corregido: corregido_cb ? corregido_cb.checked : false,
                    marcar_descartado: descartado_cb ? descartado_cb.checked : false,
                    comentario_admin: textarea ? textarea.value : ''
                };

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Error en el servidor'); });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.status === 'ok') {
                        showToast('¡Cambio guardado exitosamente!', 'success');

                        // Si se marcó corregido o descartado, recargar para ver el nuevo estado
                        if (data.marcar_corregido || data.marcar_descartado) {
                            button.innerHTML = '<i class="fas fa-check"></i> Guardado';
                            setTimeout(() => { location.reload(); }, 1200);
                        } else {
                            // Solo comentario guardado
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-save me-1"></i> Guardar';
                        }
                    } else {
                        showToast(result.message || 'Error desconocido al guardar.', 'danger');
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-save me-1"></i> Guardar';
                    }
                })
                .catch(error => {
                    showToast(error.message || 'Error de red. No se pudo guardar.', 'danger');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-save me-1"></i> Guardar';
                });
            });
        });

        // --- Lógica para actualizar enlaces de reportes (Existente) ---
        const checklistModals = document.querySelectorAll('[id^="checklistModal-"]');
        checklistModals.forEach(modal => {
            const startDateInput = modal.querySelector('.report-date-filter[id^="report_start_date-"]');
            const endDateInput = modal.querySelector('.report-date-filter[id^="report_end_date-"]');
            const pdfLink = modal.querySelector('.report-pdf-link');
            const excelLink = modal.querySelector('.report-excel-link');

            const updateReportLinks = () => {
                if (!startDateInput || !endDateInput || !pdfLink || !excelLink) return;
                const start = startDateInput.value;
                const end = endDateInput.value;
                const pdfBaseUrl = pdfLink.dataset.baseUrl;
                const excelBaseUrl = excelLink.dataset.baseUrl;
                const queryString = `?start_date=${start}&end_date=${end}`;
                pdfLink.href = pdfBaseUrl + queryString;
                excelLink.href = excelBaseUrl + queryString;
            };

            if (startDateInput) startDateInput.addEventListener('change', updateReportLinks);
            if (endDateInput) endDateInput.addEventListener('change', updateReportLinks);
            modal.addEventListener('shown.bs.modal', updateReportLinks);
        });


        // --- NUEVO: Lógica de Filtros de Tabla ---
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const tableBody = document.getElementById('assignmentsTableBody');
        const allRows = tableBody.querySelectorAll('.asignacion-row');
        const noResultsRow = document.getElementById('noResultsRow');

        function filterTable() {
            const searchText = searchInput.value.toLowerCase().trim();
            const statusValue = statusFilter.value;
            let visibleRows = 0;

            allRows.forEach(row => {
                const searchableText = row.dataset.searchableText.toLowerCase();
                const status = row.dataset.status;

                const matchesSearch = searchableText.includes(searchText);
                const matchesStatus = (statusValue === 'ALL' || status === statusValue);

                if (matchesSearch && matchesStatus) {
                    row.classList.remove('d-none');
                    visibleRows++;
                } else {
                    row.classList.add('d-none');
                }
            });

            // Mostrar u ocultar la fila "sin resultados"
            if (visibleRows === 0) {
                noResultsRow.classList.remove('d-none');
            } else {
                noResultsRow.classList.add('d-none');
            }
        }

        // Añadir listeners
        if (searchInput) searchInput.addEventListener('input', filterTable);
        if (statusFilter) statusFilter.addEventListener('change', filterTable);
        
        // --- FIN NUEVO ---

        // --- NUEVO: Actualizar enlace "Ver Monitor" según la fecha seleccionada ---
        (function() {
            const fechaInput = document.getElementById('filterFechaInput');
            const monitorBtn = document.getElementById('verMonitorBtn');
            if (!monitorBtn) return;

            const baseUrl = monitorBtn.dataset.baseUrl || monitorBtn.getAttribute('href') || '';

            function updateMonitorHref() {
                const fecha = (fechaInput && fechaInput.value) ? fechaInput.value : '';
                // Si no hay fecha, dejar la url base sin query (o añadir la fecha por defecto)
                monitorBtn.href = fecha ? `${baseUrl}?fecha=${encodeURIComponent(fecha)}` : baseUrl;
            }

            // Actualizar al cargar y cuando cambie la fecha
            updateMonitorHref();
            if (fechaInput) fechaInput.addEventListener('change', updateMonitorHref);
        })();

        // --- Evitar selección mutua de checkboxes dentro de cada modal ---
        const allModals = document.querySelectorAll('[id^="checklistModal-"]');
        allModals.forEach(modal => {
            const corregirChecks = modal.querySelectorAll('.check-corregir');
            const descartarChecks = modal.querySelectorAll('.check-descartar');

            corregirChecks.forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.checked) {
                        const pk = this.dataset.itemPk;
                        const otherCb = modal.querySelector(`#descartado-${pk}`);
                        if (otherCb) otherCb.checked = false;
                    }
                });
            });

            descartarChecks.forEach(cb => {
                cb.addEventListener('change', function() {
                    if (this.checked) {
                        const pk = this.dataset.itemPk;
                        const otherCb = modal.querySelector(`#corregido-${pk}`);
                        if (otherCb) otherCb.checked = false;
                    }
                });
            });
        });

    });

</script>
{% endblock %}