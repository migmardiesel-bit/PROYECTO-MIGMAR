{% extends "base.html" %}

{% block content %}
<div class="card shadow-lg border-0" style="border-radius: var(--border-radius-lg);">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center" style="border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: 1.25rem 1.5rem;">
        <h4 class="mb-0"><i class="fas fa-ticket-alt me-2"></i> {{ titulo }}</h4>
        <a href="{% url url_crear %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Nueva Entrega
        </a>
    </div>

    <div class="card-body p-4">
        <form method="get" class="mb-4 p-3 bg-light" style="border-radius: var(--border-radius);">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="id_operador" class="form-label fw-bold">Filtrar por Operador:</label>
                    <select name="operador" id="id_operador" class="form-control select2-widget-operador">
                        <option value="">--------- Todos los Operadores ---------</option>
                        {% if selected_operador %}
                            <option value="{{ selected_operador.id }}" selected>{{ selected_operador.nombre }} {{ selected_operador.apellido }}</option>
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="id_unidad" class="form-label fw-bold">Filtrar por Unidad:</label>
                    <select name="unidad" id="id_unidad" class="form-control select2-widget-unidad">
                        <option value="">--------- Todas las Unidades ---------</option>
                        {% if selected_unidad %}
                            <option value="{{ selected_unidad.id }}" selected>{{ selected_unidad.nombre }}</option>
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success w-100"><i class="fas fa-filter me-1"></i> Filtrar</button>
                </div>
                <div class="col-md-2">
                    <a href="{% url 'entrega-suministros-list' %}" class="btn btn-outline-secondary w-100"><i class="fas fa-times me-1"></i> Limpiar</a>
                </div>
            </div>
        </form>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        {% for header in headers %}
                            <th class="text-nowrap">{{ header }}</th>
                        {% endfor %}
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in object_list %}
                    <tr>
                        <td>{{ forloop.counter|add:page_obj.start_index|add:"-1" }}</td>
                        <td class="text-nowrap">{{ item.operador.nombre }} {{ item.operador.apellido }}</td>
                        <td class="text-nowrap">{{ item.fecha_entrega|date:"d/m/Y" }}</td>
                        <td>{{ item.cant_cinchos|default_if_none:"" }}</td>
                        <td>{{ item.folio_inicial|default_if_none:"" }}</td>
                        <td>{{ item.folio_final|default_if_none:"" }}</td>
                        <td>{{ item.unidad.nombre|default_if_none:"" }}</td>
                        
                        <td class="text-center">
                            {% if item.para_motor %}
                                <i class="fas fa-check-circle text-success" title="Motor"></i>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.para_thermo %}
                                <i class="fas fa-check-circle text-success" title="Thermo"></i>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.entregado %}
                                <i class="fas fa-check-circle text-success" title="Entregado"></i>
                            {% else %}
                                <i class="fas fa-times-circle text-muted" title="Pendiente"></i>
                            {% endif %}
                        </td>
                        <td class="text-nowrap">
                            <a href="{% url url_update_name item.pk %}" class="btn btn-sm btn-outline-primary me-1" title="Editar">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                            <a href="{% url url_delete_name item.pk %}" class="btn btn-sm btn-outline-danger" title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ headers|length|add:1 }}" class="text-center text-muted">No se encontraron registros de entregas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if is_paginated %}
            {% comment %} 
              Aquí está la corrección: 
              Se usa la ruta con espacio de nombres 'flota/paginacion.html' 
            {% endcomment %}
            {% include "flota/paginacion.html" %}
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('.select2-widget-operador').select2({
            theme: "bootstrap-5",
            width: '100%',
            ajax: {
                url: "{% url 'operador-search-api' %}", 
                dataType: 'json',
                delay: 250,
                data: function (params) { return { term: params.term }; },
                processResults: function (data) { return { results: data.results }; },
                cache: true
            },
            placeholder: 'Buscar operador...',
            minimumInputLength: 2
        });
        
        $('.select2-widget-unidad').select2({
            theme: "bootstrap-5",
            width: '100%',
            ajax: {
                url: "{% url 'api-search-unidades' %}",
                dataType: 'json',
                delay: 250,
                data: function (params) { return { term: params.term }; },
                processResults: function (data) { return { results: data.results }; },
                cache: true
            },
            placeholder: 'Buscar unidad...',
            minimumInputLength: 2
        });
    });
</script>
{% endblock %}