{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <!-- Header de formulario -->
            <div class="d-flex align-items-center mb-4">
                <div class="flex-shrink-0">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                        <i class="fas fa-file-alt text-white"></i>
                    </div>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h1 class="h3 mb-0 text-primary">{{ titulo }}</h1>
                    <p class="text-muted mb-0">Complete todos los campos requeridos marcados con <span class="text-danger">*</span></p>
                </div>
                <div class="flex-shrink-0">
                    <span class="badge bg-light text-dark border">
                        <i class="fas fa-save me-1"></i>Guardar
                    </span>
                </div>
            </div>

            <!-- Tarjeta del formulario -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clipboard-list text-primary me-2"></i>
                        Información del Formulario
                    </h5>
                </div>
                
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="professionalForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Progreso del formulario (opcional) -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">Progreso del formulario</small>
                                <small class="text-muted"><span id="completed-fields">0</span>/<span id="total-fields">0</span> campos</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div id="form-progress" class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <!-- Mensajes de alerta -->
                        {% if form.errors %}
                        <div class="alert alert-danger d-flex align-items-center" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                Por favor, corrija los errores en el formulario.
                            </div>
                        </div>
                        {% endif %}

                        <!-- Renderizado de campos del formulario -->
                        {% for field in form %}
                        <div class="mb-4 field-group" data-field-name="{{ field.name }}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="{{ field.id_for_label }}" class="form-label fw-semibold">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="text-danger ms-1">*</span>{% endif %}
                                </label>
                                <small class="text-muted field-status">
                                    <i class="fas fa-check-circle text-success d-none"></i>
                                    <i class="fas fa-exclamation-circle text-warning d-none"></i>
                                </small>
                            </div>
                            
                            <!-- Campo de entrada -->
                            {% if field.field.widget.input_type == 'checkbox' %}
                            <div class="form-check form-switch">
                                {{ field|add_class:"form-check-input" }}
                                <label class="form-check-label" for="{{ field.id_for_label }}">
                                    {{ field.help_text|default:"" }}
                                </label>
                            </div>
                            {% else %}
                                {{ field|add_class:"form-control" }}
                            {% endif %}
                            
                            <!-- Mensajes de ayuda y error -->
                            {% if field.help_text %}
                            <div class="form-text text-muted mt-1">
                                <i class="fas fa-info-circle me-1"></i>{{ field.help_text }}
                            </div>
                            {% endif %}
                            
                            {% for error in field.errors %}
                            <div class="invalid-feedback d-block mt-1">
                                <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}

                        <!-- Sección de acciones -->
                        <div class="border-top pt-4 mt-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-outline-secondary" id="clearFormBtn">
                                        <i class="fas fa-eraser me-1"></i>Limpiar
                                    </button>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="fas fa-save me-1"></i>Guardar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Footer informativo -->
                <div class="card-footer bg-light py-3">
                    <div class="row text-center text-sm-start">
                        <div class="col-sm-6">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>
                                Usuario: {{ request.user.get_full_name|default:request.user.username }}
                            </small>
                        </div>
                        <div class="col-sm-6 text-sm-end">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                Fecha: <span id="current-date">{{ current_date|date:"d/m/Y" }}</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    border-radius: 12px;
    overflow: hidden;
}

.card-header {
    border-bottom: 1px solid rgba(0,0,0,.05);
}

.field-group {
    transition: all 0.3s ease;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid transparent;
}

.field-group:hover {
    background-color: #f8f9fa;
}

.field-group:focus-within {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.03);
}

.form-control, .form-select {
    border-radius: 6px;
    padding: 10px 15px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
    border-color: #86b7fe;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.form-switch .form-check-input {
    height: 1.5em;
}

.btn {
    border-radius: 6px;
    padding: 10px 20px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #0a58ca 0%, #084298 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
}

.progress {
    border-radius: 10px;
    background-color: #e9ecef;
}

.progress-bar {
    border-radius: 10px;
    transition: width 0.5s ease;
}

.alert {
    border-radius: 8px;
    border: none;
}

.invalid-feedback {
    font-size: 0.875rem;
}

.bg-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar fecha actual
    const now = new Date();
    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
    document.getElementById('current-date').textContent = now.toLocaleDateString('es-ES', options);
    
    // Sistema de progreso del formulario
    const formFields = document.querySelectorAll('.field-group');
    const progressBar = document.getElementById('form-progress');
    const completedFieldsElement = document.getElementById('completed-fields');
    const totalFieldsElement = document.getElementById('total-fields');
    
    totalFieldsElement.textContent = formFields.length;
    
    function updateFormProgress() {
        let completedCount = 0;
        
        formFields.forEach(fieldGroup => {
            const field = fieldGroup.querySelector('input, select, textarea');
            const statusIcon = fieldGroup.querySelector('.field-status');
            
            if (field) {
                let isCompleted = false;
                
                if (field.type === 'checkbox' || field.type === 'radio') {
                    isCompleted = field.checked;
                } else if (field.type === 'file') {
                    isCompleted = field.files.length > 0;
                } else {
                    isCompleted = field.value.trim() !== '';
                }
                
                // Actualizar icono de estado
                const checkIcon = statusIcon.querySelector('.fa-check-circle');
                const warningIcon = statusIcon.querySelector('.fa-exclamation-circle');
                
                if (isCompleted) {
                    checkIcon.classList.remove('d-none');
                    warningIcon.classList.add('d-none');
                    completedCount++;
                } else if (field.hasAttribute('required')) {
                    checkIcon.classList.add('d-none');
                    warningIcon.classList.remove('d-none');
                } else {
                    checkIcon.classList.add('d-none');
                    warningIcon.classList.add('d-none');
                }
            }
        });
        
        const progressPercentage = (completedCount / formFields.length) * 100;
        progressBar.style.width = `${progressPercentage}%`;
        progressBar.setAttribute('aria-valuenow', progressPercentage);
        completedFieldsElement.textContent = completedCount;
        
        // Cambiar color según progreso
        if (progressPercentage < 30) {
            progressBar.className = 'progress-bar bg-danger';
        } else if (progressPercentage < 70) {
            progressBar.className = 'progress-bar bg-warning';
        } else if (progressPercentage < 100) {
            progressBar.className = 'progress-bar bg-info';
        } else {
            progressBar.className = 'progress-bar bg-success';
        }
    }
    
    // Escuchar cambios en todos los campos
    formFields.forEach(fieldGroup => {
        const field = fieldGroup.querySelector('input, select, textarea');
        if (field) {
            field.addEventListener('input', updateFormProgress);
            field.addEventListener('change', updateFormProgress);
        }
    });
    
    // Inicializar progreso
    updateFormProgress();
    
    // Botón de limpiar formulario
    document.getElementById('clearFormBtn').addEventListener('click', function() {
        if (confirm('¿Está seguro de que desea limpiar todos los campos del formulario?')) {
            document.getElementById('professionalForm').reset();
            updateFormProgress();
        }
    });
    
    // Validación de formulario antes de enviar
    document.getElementById('professionalForm').addEventListener('submit', function(event) {
        let isValid = true;
        let firstInvalidField = null;
        
        formFields.forEach(fieldGroup => {
            const field = fieldGroup.querySelector('input, select, textarea');
            if (field && field.hasAttribute('required') && !field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
                
                if (!firstInvalidField) {
                    firstInvalidField = field;
                }
            } else if (field) {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            event.preventDefault();
            event.stopPropagation();
            
            // Desplazarse al primer campo inválido
            if (firstInvalidField) {
                firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidField.focus();
            }
            
            // Mostrar alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Formulario incompleto:</strong> Por favor, complete todos los campos requeridos.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.replaceWith(alertDiv);
            } else {
                document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.needs-validation'));
            }
        }
    });
});
</script>
{% endblock %}